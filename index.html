<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mainsudoku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Default Theme Variables (Teal/Emerald) */
        :root {
            --primary-color: #0d9488; /* Teal-600 */
            --primary-light-bg: #f0fdfa; /* Teal-50 */
            --primary-border: #14b8a6; /* Teal-500 */
            --primary-text: #0d9488;
            --background-color: #f3f4f6; /* Default Light BG */
            --text-color: #1f2937; /* Default Dark Text */
            --card-bg: #ffffff;
            --cell-size: clamp(44px, 11vw, 63px);
        }
        
        /* Dark Background Setting */
        .dark-mode {
            --background-color: #1f2937; /* Gray-800 */
            --text-color: #f3f4f6; /* Light Text */
            --card-bg: #374151; /* Gray-700 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 10vh;
            transition: background-color 0.3s, color 0.3s;
        }

        #game-container, #leaderboard-container, #theme-settings {
            background-color: var(--card-bg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border-radius: 14px;
            padding: 20px;
            max-width: 700px;
            width: 100%;
            margin-bottom: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Sudoku Grid Styles */
        #sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, var(--cell-size));
            grid-auto-rows: var(--cell-size);
            gap: 0; 
            border: 4px solid var(--text-color);
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto 18px;
            width: fit-content;
            background: #fff;
        }

        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.25rem;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            user-select: none;
            cursor: pointer;
            transition: background-color 0.08s, transform 0.06s;
            box-sizing: border-box;
            background-color: #ffffff;
            outline: none;
            color: #1f2937;
        }
        
        .dark-mode .cell {
            background-color: #4b5563; /* Darker cell default */
            border-color: #374151;
            color: #e5e7eb;
        }
        
        .dark-mode .cell.initial-value {
            background: linear-gradient(180deg, #4b5563, #374151);
            color: #f3f4f6;
        }


        .cell:nth-child(9n+3),
        .cell:nth-child(9n+6) {
            border-right: 3px solid var(--text-color);
        }

        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 3px solid var(--text-color);
        }

        .cell:nth-child(9n) {
            border-right: 1px solid #e5e7eb; 
        }
        
        .dark-mode .cell:nth-child(9n) {
             border-right: 1px solid #374151; 
        }


        .cell.initial-value {
            color: #111827;
            font-weight: 800;
            cursor: default;
            background: linear-gradient(180deg, #ffffff, #fafafa);
        }

        /* Highlighted related cells */
        .cell.highlighted-related {
            background-color: var(--primary-light-bg); 
        }
        .dark-mode .cell.highlighted-related {
            background-color: rgba(var(--primary-color-rgb), 0.2); 
        }


        .cell.highlighted-duplicate {
            background-color: #fcf4db;
        }
        .dark-mode .cell.highlighted-duplicate {
            background-color: #584f3c;
        }
        
        /* Selected cell */
        .cell.selected {
            background-color: rgba(var(--primary-color-rgb), 0.25);
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }
        .dark-mode .cell.selected {
            background-color: rgba(var(--primary-color-rgb), 0.4);
        }


        .cell.error,
        .cell.error.highlighted-related,
        .cell.error.highlighted-duplicate,
        .cell.error.selected {
            background-color: #fecaca !important;
            color: #991b1b !important;
        }
        .dark-mode .cell.error,
        .dark-mode .cell.error.highlighted-related,
        .dark-mode .cell.error.highlighted-duplicate,
        .dark-mode .cell.error.selected {
            background-color: #b91c1c !important;
            color: #fca5a5 !important;
        }


        .number-button, .difficulty-button, .theme-button {
            width: 100%;
            height: 48px;
            font-size: 1.05rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.14s;
            cursor: pointer;
            border: 2px solid;
            user-select: none; /* Ensure text is not selected during drag */
        }
        
        .number-key-size {
            width: 18.5%; 
        }

        .number-button {
            background-color: var(--primary-light-bg); 
            color: var(--primary-color);
            border-color: var(--primary-border);
        }
        
        .dark-mode .number-button {
            background-color: rgba(var(--primary-color-rgb), 0.2);
            color: var(--primary-border);
            border-color: var(--primary-color);
        }

        .number-button:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
            cursor: not-allowed;
        }
        
        .dark-mode .number-button:disabled {
            background-color: #374151;
            color: #6b7280;
            border-color: #4b5563;
        }


        .action-button {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        #message-box { min-height: 44px; }

        @media (max-width: 420px) {
            :root { --cell-size: clamp(36px, 13vw, 60px); }
            .number-button { height:44px; }
            .difficulty-button { height: 40px; font-size: 0.9rem; }
            
            .number-key-size {
                width: 22%;
            }
        }
        
        /* Leaderboard Styles */
        .leaderboard-table th, .leaderboard-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
            color: var(--text-color);
        }
        .dark-mode .leaderboard-table th, .dark-mode .leaderboard-table td {
            border-bottom: 1px solid #4b5563;
        }

        .leaderboard-table th {
            background-color: #f9fafb;
            color: #4b5563;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .dark-mode .leaderboard-table th {
            background-color: #374151;
            color: #9ca3af;
        }

        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Monospaced font for timer/leaderboard time */
        #timer-display, .leaderboard-table .font-mono {
             font-family: 'Space Mono', monospace;
        }

        /* Custom color classes for theme selection */
        .color-selector {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.15s;
        }
        .color-selector.selected-theme {
            border-color: var(--text-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
    </style>
</head>
<body class="p-4 flex flex-col items-center">

<div id="game-container" class="mt-4 sm:mt-6">
    
    <!-- Language Toggle and Title -->
    <div class="flex justify-between items-center mb-4">
        <button id="lang-toggle-button" class="action-button bg-gray-700 text-white text-sm py-2 px-3">EN</button>
        <h1 class="text-3xl font-extrabold text-gray-800 text-center flex-grow" id="app-title">
            Mainsudoku
        </h1>
        <div class="w-[58px]"></div> <!-- Spacer to center the title -->
    </div>
    
    <!-- Player Info and Timer -->
    <div class="flex items-center justify-between mb-4 space-x-3 p-3 rounded-lg" style="background-color: var(--primary-light-bg); border: 1px solid var(--primary-border);">
        <!-- Player Name Input -->
        <div class="flex flex-col flex-grow">
            <!-- Label is dynamically updated -->
            <label for="player-name" class="text-xs font-medium text-gray-700 mb-1" data-lang-key="label_name" style="color: var(--primary-text);">Sila Masukkan Nama Anda</label> 
            <!-- Placeholder is now empty and will be set by JS based on language -->
            <input type="text" id="player-name" class="p-1 border rounded-md text-sm font-semibold text-gray-800 focus:ring-4 focus:ring-opacity-50" 
                   placeholder="" style="border-color: var(--primary-border); focus-ring-color: var(--primary-color);" maxlength="20"> 
        </div>

        <!-- Timer Display and Pause Button -->
        <div class="flex items-center space-x-3">
            <div class="text-lg font-semibold text-gray-800" id="timer-label" data-lang-key="label_time" style="color: var(--text-color);">Masa:</div>
            <div id="timer-display" class="text-3xl font-bold" style="color: var(--primary-color);">00:00</div> 
            <!-- Button is disabled by default until name is entered -->
            <button id="pause-button" class="action-button bg-green-500 text-white shadow-md text-sm py-1 px-3" data-lang-key="button_start" disabled>Mula</button>
        </div>
    </div>


    <!-- Difficulty Selector -->
    <div id="difficulty-selector" class="flex justify-between space-x-2 mb-4">
        <button class="difficulty-button bg-gray-200 text-gray-700 border-gray-300 hover:bg-gray-100" data-level="EASY" data-lang-key="difficulty_easy">MUDAH</button>
        <button class="difficulty-button bg-gray-200 text-gray-700 border-gray-700 hover:bg-gray-100" data-level="MEDIUM" data-lang-key="difficulty_medium">SEDERHANA</button>
        <button class="difficulty-button bg-gray-200 text-gray-700 border-gray-700 hover:bg-gray-100" data-level="HARD" data-lang-key="difficulty_hard">SUKAR</button>
    </div>

    <div id="sudoku-grid" role="grid" aria-label="Sudoku board"></div>

    <div id="message-box" class="text-center font-semibold mb-3 text-gray-600" data-lang-key="message_generating" style="color: var(--text-color);">Menjana teka-teki baru... Sila tunggu.</div>

    <div id="number-pad" class="grid grid-cols-5 gap-2 mb-4">
        <!-- Row 1: 1, 2, 3, 4, 5 -->
        <!-- Added draggable="true" to all number buttons -->
        <button class="number-button" data-number="1" draggable="true" disabled>1</button>
        <button class="number-button" data-number="2" draggable="true" disabled>2</button>
        <button class="number-button" data-number="3" draggable="true" disabled>3</button>
        <button class="number-button" data-number="4" draggable="true" disabled>4</button>
        <button class="number-button" data-number="5" draggable="true" disabled>5</button>

        <!-- Row 2: Centered 6, 7, 8, 9 -->
        <div class="col-span-5 flex justify-center space-x-2">
            <button class="number-button number-key-size" data-number="6" draggable="true" disabled>6</button>
            <button class="number-button number-key-size" data-number="7" draggable="true" disabled>7</button>
            <button class="number-button number-key-size" data-number="8" draggable="true" disabled>8</button>
            <button class="number-button number-key-size" data-number="9" draggable="true" disabled>9</button>
        </div>
        
        <!-- Row 3: Clear button spans all 5 columns. Clear is not draggable. -->
        <button id="clear-button" class="number-button col-span-5 bg-red-500 text-white border-red-700 hover:bg-red-600" data-number="0" data-lang-key="button_clear" disabled>Padam</button>
    </div>

    <div class="flex justify-center space-x-3">
        <!-- Hint Button -->
        <button id="hint-button" class="action-button bg-yellow-500 text-white shadow-md" data-lang-key="button_hint" disabled>Petunjuk (3)</button>
        <button id="check-button" class="action-button bg-emerald-500 text-white shadow-md" disabled data-lang-key="button_check" style="background-color: var(--primary-color);">Semak Jawapan</button> 
        <button id="new-game-button" class="action-button bg-gray-200 text-gray-800 border border-gray-300" data-lang-key="button_new_game">Permainan Baru</button>
    </div>
</div>

<!-- Theme Settings Container (NEW) -->
<div id="theme-settings" class="mt-4">
    <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="theme_title" style="color: var(--primary-color);">Tetapan Tema</h2>
    
    <!-- 1. Primary Color Selector -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold mb-2" data-lang-key="theme_primary_color">Warna Utama (Aksen)</h3>
        <div id="primary-color-selector" class="flex justify-center space-x-4">
            <div class="color-selector bg-emerald-500 selected-theme" data-color-key="TEAL" data-color-code="#10b981" data-rgb="16, 185, 129"></div>
            <div class="color-selector bg-blue-500" data-color-key="BLUE" data-color-code="#3b82f6" data-rgb="59, 130, 246"></div>
            <div class="color-selector bg-indigo-500" data-color-key="INDIGO" data-color-code="#6366f1" data-rgb="99, 102, 241"></div>
            <div class="color-selector bg-rose-500" data-color-key="ROSE" data-color-code="#f43f5e" data-rgb="244, 63, 94"></div>
            <div class="color-selector bg-orange-500" data-color-key="ORANGE" data-color-code="#f97316" data-rgb="249, 115, 22"></div>
        </div>
    </div>

    <!-- 2. Background Selector -->
    <div>
        <h3 class="text-lg font-semibold mb-2" data-lang-key="theme_background_color">Warna Latar Belakang</h3>
        <div id="background-selector" class="flex justify-center space-x-4">
            <button class="theme-button bg-gray-200 text-gray-700 border-gray-300" data-bg-key="LIGHT" data-lang-key="theme_bg_light">Cerah</button>
            <button class="theme-button bg-gray-200 text-gray-700 border-gray-300" data-bg-key="DARK" data-lang-key="theme_bg_dark">Gelap</button>
            <button class="theme-button bg-gray-200 text-gray-700 border-gray-300" data-bg-key="NEUTRAL" data-lang-key="theme_bg_neutral">Neutral</button>
        </div>
    </div>
</div>


<!-- Leaderboard Container -->
<div id="leaderboard-container">
    <h2 class="text-2xl font-bold mb-4 text-center" data-lang-key="leaderboard_title" style="color: var(--primary-color);">Papan Pendahulu</h2>
    
    <!-- Difficulty filter for Leaderboard -->
    <div id="leaderboard-difficulty-filter" class="flex justify-center space-x-2 mb-4">
        <button class="difficulty-button bg-gray-200 text-white border-gray-300 shadow-md" data-level="EASY" data-leaderboard-filter="EASY" data-lang-key="difficulty_easy">MUDAH</button> 
        <button class="difficulty-button bg-gray-200 text-gray-700 border-gray-300 hover:bg-gray-100" data-level="MEDIUM" data-leaderboard-filter="MEDIUM" data-lang-key="difficulty_medium">SEDERHANA</button> 
        <button class="difficulty-button bg-gray-200 text-gray-700 border-gray-300 hover:bg-gray-100" data-level="HARD" data-leaderboard-filter="HARD" data-lang-key="difficulty_hard">SUKAR</button> 
    </div>

    <div id="leaderboard-content">
        <!-- Leaderboard data will be inserted here -->
        <p class="text-center text-gray-500" data-lang-key="leaderboard_loading">Memuatkan skor...</p>
    </div>
    <p id="current-user-id" class="text-xs text-gray-400 mt-4 text-center"></p>
</div>

<div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center" style="background-color: var(--card-bg);">
        <h3 id="modal-title" class="text-2xl font-bold mb-3" style="color: var(--primary-color);">Tahniah!</h3> 
        <p id="modal-content" class="text-gray-700 mb-4" style="color: var(--text-color);">Anda berjaya menyelesaikannya!</p>
        <button id="modal-close-button" class="action-button bg-emerald-500 text-white w-full" data-lang-key="modal_close" style="background-color: var(--primary-color);">Tutup</button> 
    </div>
</div>

<script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firebase Log Level
    setLogLevel('Debug');
    
    // --- GLOBAL FIREBASE/APP VARIABLES ---
    let db;
    let auth;
    let userId = null;
    let userName = ''; // Initial name is empty
    let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sudoku-app-id';
    let currentLeaderboardFilter = 'EASY';

    // --- THEME VARIABLES ---
    const THEMES = {
        TEAL: { color: '#10b981', rgb: '16, 185, 129', light_bg: '#f0fdfa', border: '#14b8a6' }, // Emerald-500/Teal-50
        BLUE: { color: '#3b82f6', rgb: '59, 130, 246', light_bg: '#eff6ff', border: '#60a5fa' }, // Blue-500/Blue-50
        INDIGO: { color: '#6366f1', rgb: '99, 102, 241', light_bg: '#eef2ff', border: '#818cf8' }, // Indigo-500/Indigo-50
        ROSE: { color: '#f43f5e', rgb: '244, 63, 94', light_bg: '#fff1f2', border: '#fb7185' }, // Rose-500/Rose-50
        ORANGE: { color: '#f97316', rgb: '249, 115, 22', light_bg: '#fff7ed', border: '#fb923c' }, // Orange-500/Orange-50
    };
    let currentThemeKey = 'TEAL';
    let currentBackgroundKey = 'LIGHT';


    // --- LANGUAGE CONSTANT ---
    const LANGUAGES = {
        ms: {
            difficulty_easy: 'MUDAH', difficulty_medium: 'SEDERHANA', difficulty_hard: 'SUKAR',
            label_name: 'Sila Masukkan Nama Anda', label_time: 'Masa:',
            input_placeholder: 'Tulis nama anda', // UPDATED FOR MONOLINGUAL INPUT
            message_generating: 'Menjana teka-teki baru... Sila tunggu.',
            message_enter_name: 'Sila masukkan nama anda untuk memulakan permainan.', 
            message_loaded: (level) => `Teka-teki ${level} baru dimuatkan.`,
            message_press_play_to_start: "Tekan 'Mula' untuk memulakan pemasa dan mula bermain!",
            message_select_cell: (r, c) => `Dipilih: Baris ${r}, Lajur ${c}. Masukkan nombor.`,
            message_no_selection: 'Sila pilih sel dahulu!',
            message_fixed_value: 'Anda tidak boleh menukar nilai awal atau sel yang dibantu!',
            message_keep_going: 'Teruskan! Papan belum lengkap. Sel yang salah diserlahkan.',
            message_no_hints: 'Tiada petunjuk lagi!',
            message_select_hint_cell: 'Sila pilih sel kosong untuk mendapatkan petunjuk.',
            message_hint_used: (val, rem) => `Petunjuk digunakan! Nombor yang betul ${val} telah diletakkan. (${rem} baki)`,
            message_paused: 'Permainan dihentikan. Tekan "Sambung" untuk menyambung.',
            message_score_saving: 'Menghantar skor ke Papan Pendahulu...',
            message_score_saved: 'Skor anda telah dihantar!',
            button_clear: 'Padam',
            button_hint: (rem) => `Petunjuk (${rem})`,
            button_check: 'Semak Jawapan',
            button_new_game: 'Permainan Baru',
            button_pause: 'Henti',
            button_play: 'Sambung', // Resume
            button_start: 'Mula', // Initial Start
            modal_solved_title: 'Tahniah!',
            modal_solved_content: (time) => `Anda berjaya menyelesaikannya dalam ${time}! Skor dihantar.`,
            modal_error_title: 'Hampir berjaya!',
            modal_error_content: 'Beberapa sel tidak betul. Terus mencuba!',
            modal_close: 'Tutup',
            lang_toggle_text: 'EN',
            aria_row: 'Baris',
            aria_col: 'Lajur',
            leaderboard_title: 'Papan Pendahulu',
            leaderboard_rank: 'Rangking',
            leaderboard_player: 'Pemain',
            leaderboard_time: 'Masa',
            leaderboard_date: 'Tarikh',
            leaderboard_loading: 'Memuatkan skor...',
            leaderboard_empty: (level) => `Tiada skor untuk tahap ${level} lagi. Jadilah yang pertama!`,
            theme_title: 'Tetapan Tema',
            theme_primary_color: 'Warna Utama (Aksen)',
            theme_background_color: 'Warna Latar Belakang',
            theme_bg_light: 'Cerah',
            theme_bg_dark: 'Gelap',
            theme_bg_neutral: 'Neutral',
        },
        en: {
            difficulty_easy: 'EASY', difficulty_medium: 'MEDIUM', difficulty_hard: 'HARD',
            label_name: 'Please Enter Your Name', label_time: 'Time:',
            input_placeholder: 'Enter your name', // UPDATED FOR MONOLINGUAL INPUT
            message_generating: 'Generating new puzzle... Please wait.',
            message_enter_name: 'Please enter your name to start the game.', 
            message_loaded: (level) => `New ${level} puzzle loaded.`,
            message_press_play_to_start: "Press 'Start' to start the timer and begin playing!",
            message_select_cell: (r, c) => `Selected: Row ${r}, Column ${c}. Enter a number.`,
            message_no_selection: 'Please select a cell first!',
            message_fixed_value: 'You cannot change the initial values or hinted cells!',
            message_keep_going: 'Keep going! The board is not complete yet. Incorrect cells are highlighted.',
            message_no_hints: 'No more hints available!',
            message_select_hint_cell: 'Please select an empty cell to get a hint.',
            message_hint_used: (val, rem) => `Hint used! The correct number ${val} has been placed. (${rem} left)`,
            message_paused: 'Game paused. Press "Resume" to resume.',
            message_score_saving: 'Submitting score to Leaderboard...',
            message_score_saved: 'Your score has been submitted!',
            button_clear: 'Clear',
            button_hint: (rem) => `Hint (${rem})`,
            button_check: 'Check Solution',
            button_new_game: 'New Game',
            button_pause: 'Pause',
            button_play: 'Resume',
            button_start: 'Start',
            modal_solved_title: 'Well Done!',
            modal_solved_content: (time) => `You successfully solved it in ${time}! Score submitted.`,
            modal_error_title: 'Almost there!',
            modal_error_content: 'Some cells are incorrect. Keep trying!',
            modal_close: 'Close',
            lang_toggle_text: 'BM',
            aria_row: 'Row',
            aria_col: 'Column',
            leaderboard_title: 'Leaderboard',
            leaderboard_rank: 'Rank',
            leaderboard_player: 'Player',
            leaderboard_time: 'Time',
            leaderboard_date: 'Date',
            leaderboard_loading: 'Loading scores...',
            leaderboard_empty: (level) => `No scores for ${level} difficulty yet. Be the first!`,
            theme_title: 'Theme Settings',
            theme_primary_color: 'Primary Color (Accent)',
            theme_background_color: 'Background Color',
            theme_bg_light: 'Light',
            theme_bg_dark: 'Dark',
            theme_bg_neutral: 'Neutral',
        }
    };

    const DIFFICULTY_LEVELS = { EASY: 42, MEDIUM: 32, HARD: 25 };
    const HINT_LIMIT = 3; 

    // Game state variables
    let currentBoard = [];
    let initialBoard = [];
    let fullSolution = [];
    let selectedCell = {row:-1, col:-1};
    let currentDifficulty = DIFFICULTY_LEVELS.MEDIUM;
    let currentDifficultyKey = 'MEDIUM';
    let timerInterval = null;
    let timeElapsed = 0;
    let isTimerRunning = false;
    let hintsRemaining = HINT_LIMIT;
    let currentLang = 'ms';
    let isAuthReady = false; 

    // DOM Elements
    const root = document.documentElement;
    const body = document.body;
    const gridElement = document.getElementById('sudoku-grid');
    const messageBox = document.getElementById('message-box');
    const timerDisplay = document.getElementById('timer-display');
    const numberButtons = document.querySelectorAll('#number-pad .number-button');
    const checkButton = document.getElementById('check-button');
    const newGameButton = document.getElementById('new-game-button');
    const hintButton = document.getElementById('hint-button');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const modalCloseButton = document.getElementById('modal-close-button');
    const clearButton = document.getElementById('clear-button');
    const difficultyButtons = document.querySelectorAll('#difficulty-selector .difficulty-button');
    const langToggleButton = document.getElementById('lang-toggle-button');
    const pauseButton = document.getElementById('pause-button');
    const playerNameInput = document.getElementById('player-name');
    const leaderboardContent = document.getElementById('leaderboard-content');
    const leaderboardFilterButtons = document.querySelectorAll('[data-leaderboard-filter]');
    const currentUserIdDisplay = document.getElementById('current-user-id');
    const primaryColorSelectors = document.querySelectorAll('#primary-color-selector .color-selector');
    const backgroundSelectors = document.querySelectorAll('#background-selector .theme-button');
    
    // --- AUDIO Logic ---
    let audioContext = null;

    function createAudioContext() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playSound(type) {
        createAudioContext();
        if (!audioContext) return;

        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        if (type === 'success') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(392, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.4);

        } else if (type === 'error') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(120, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
    }

    // --- THEME Logic ---

    function applyTheme(primaryKey, bgKey) {
        currentThemeKey = primaryKey;
        currentBackgroundKey = bgKey;

        const theme = THEMES[primaryKey];
        root.style.setProperty('--primary-color', theme.color);
        root.style.setProperty('--primary-color-rgb', theme.rgb);
        root.style.setProperty('--primary-light-bg', theme.light_bg);
        root.style.setProperty('--primary-border', theme.border);

        // Background switching logic
        if (bgKey === 'DARK') {
            body.classList.add('dark-mode');
            // Override text/bg for dark mode
            root.style.setProperty('--background-color', '#1f2937'); 
            root.style.setProperty('--text-color', '#f3f4f6');
            root.style.setProperty('--card-bg', '#374151');
            
        } else if (bgKey === 'NEUTRAL') {
            body.classList.remove('dark-mode');
            // Neutral/Gray theme
            root.style.setProperty('--background-color', '#cbd5e1'); // Slate-300
            root.style.setProperty('--text-color', '#1f2937');
            root.style.setProperty('--card-bg', '#e2e8f0'); // Slate-200
            
        } else { // LIGHT
            body.classList.remove('dark-mode');
            // Default Light theme
            root.style.setProperty('--background-color', '#f3f4f6');
            root.style.setProperty('--text-color', '#1f2937');
            root.style.setProperty('--card-bg', '#ffffff');
        }

        updateThemeUI();
        updateDifficultyUI(); 
        updateLeaderboardFilterUI();
        renderBoard(); 
    }
    
    function updateThemeUI() {
        // 1. Primary Color Selectors
        primaryColorSelectors.forEach(selector => {
            selector.classList.remove('selected-theme');
            if (selector.dataset.colorKey === currentThemeKey) {
                selector.classList.add('selected-theme');
            }
        });
        
        // 2. Background Selectors (Update Active/Inactive)
        backgroundSelectors.forEach(btn => {
             // Reset to default gray state
            btn.classList.remove('bg-gray-700', 'text-white', 'border-gray-700'); 
            btn.classList.add('bg-gray-200', 'text-gray-700', 'border-gray-300');

            if (btn.dataset.bgKey === currentBackgroundKey) {
                // Apply active state (Darker gray/Black for contrast regardless of primary color)
                 btn.classList.remove('bg-gray-200', 'text-gray-700', 'border-gray-300');
                 btn.classList.add('bg-gray-700', 'text-white', 'border-gray-700');
            }
        });
    }

    // --- FIREBASE INITIALIZATION & AUTH ---

    async function initializeFirebase() {
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { 
                await signInWithCustomToken(auth, __initial_auth_token); 
            } else { 
                await signInAnonymously(auth); 
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    currentUserIdDisplay.textContent = `User ID: ${userId} | App ID: ${appId}`;
                } else {
                    userId = crypto.randomUUID();
                    currentUserIdDisplay.textContent = `User ID: ${userId} (Anon) | App ID: ${appId}`;
                }
                isAuthReady = true;
                playerNameInput.value = ''; // Ensure input is empty to force name entry
                setupNewGame();
                setupLeaderboardListener();
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            isAuthReady = true;
            playerNameInput.value = ''; // Ensure input is empty
            setupNewGame();
        }
    }
    
    // --- FIRESTORE LOGIC ---
    
    function getScoresCollectionRef() {
        return collection(db, `artifacts/${appId}/public/data/sudoku_scores`);
    }

    async function saveScoreToFirestore(timeSeconds, difficultyKey) {
        if (!db || !isAuthReady) {
            console.error("Database not ready or user not authenticated.");
            return;
        }

        try {
            // Use the current value from the input field
            const playerName = playerNameInput.value.trim() || `Pemain Anon ${userId.substring(0, 4)}`;
            
            await addDoc(getScoresCollectionRef(), {
                userId: userId,
                name: playerName,
                time: timeSeconds,
                difficulty: difficultyKey,
                date: serverTimestamp(),
            });
            console.log("Score saved successfully.");
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    }

    function renderLeaderboard(scores) {
        leaderboardContent.innerHTML = '';

        if (scores.length === 0) {
            leaderboardContent.innerHTML = `<p class="text-center text-gray-500 mt-4">${getLangText('leaderboard_empty', getLangText(`difficulty_${currentLeaderboardFilter.toLowerCase()}`))}</p>`;
            return;
        }

        const table = document.createElement('table');
        table.className = 'leaderboard-table w-full border-collapse';

        // Table Header
        table.innerHTML = `
            <thead>
                <tr>
                    <th class="rounded-tl-lg">${getLangText('leaderboard_rank')}</th>
                    <th>${getLangText('leaderboard_player')}</th>
                    <th>${getLangText('leaderboard_time')}</th>
                    <th class="rounded-tr-lg">${getLangText('leaderboard_date')}</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        scores.forEach((score, index) => {
            const dateValue = score.date?.toDate ? score.date.toDate() : (score.date ? new Date(score.date.seconds * 1000) : new Date());
            const date = dateValue.toLocaleDateString(currentLang === 'ms' ? 'ms-MY' : 'en-US');
            const timeFormatted = formatTime(score.time);
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <td class="font-semibold text-gray-700">${score.name || 'Anon'}</td>
                <td class="font-mono font-bold" style="color: var(--primary-color);">${timeFormatted}</td> <!-- Dynamic Primary Color -->
                <td class="text-sm text-gray-500">${date}</td>
            `;
            // Highlight current user's score with the active primary color
            if (score.userId === userId) {
                row.classList.add('border-l-4');
                row.style.backgroundColor = THEMES[currentThemeKey].light_bg;
                row.style.borderColor = THEMES[currentThemeKey].color;
                
                if (currentBackgroundKey === 'DARK') {
                    row.style.backgroundColor = `rgba(${THEMES[currentThemeKey].rgb}, 0.2)`;
                }
            } else {
                 row.style.backgroundColor = 'transparent';
            }
        });

        leaderboardContent.appendChild(table);
    }
    
    function setupLeaderboardListener() {
        if (!db || !isAuthReady) {
            return;
        }

        const filterLevel = currentLeaderboardFilter;

        const scoresQuery = query(
            getScoresCollectionRef(),
            where('difficulty', '==', filterLevel)
        );

        onSnapshot(scoresQuery, (querySnapshot) => {
            let scores = [];
            querySnapshot.forEach((doc) => {
                scores.push(doc.data());
            });
            
            scores.sort((a, b) => {
                if (a.time < b.time) return -1;
                if (a.time > b.time) return 1;
                
                const dateA = a.date?.seconds || 0;
                const dateB = b.date?.seconds || 0;
                
                if (dateA < dateB) return 1; 
                if (dateA > dateB) return -1; 
                
                return 0;
            });
            
            const topScores = scores.slice(0, 10);
            
            renderLeaderboard(topScores);
        }, (error) => {
            console.error("Error fetching leaderboard: ", error);
            leaderboardContent.innerHTML = `<p class="text-center text-red-500 mt-4">Ralat memuatkan Papan Pendahulu.</p>`;
        });
    }

    function updateLeaderboardFilterUI() {
        // Use the primary color for the active leaderboard filter button
        leaderboardFilterButtons.forEach(btn => {
            if (btn.dataset.leaderboardFilter === currentLeaderboardFilter) {
                btn.style.backgroundColor = THEMES[currentThemeKey].color;
                btn.classList.add('text-white', 'shadow-md');
                btn.classList.remove('bg-gray-200', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-100');
            } else {
                btn.style.backgroundColor = '';
                btn.classList.remove('text-white', 'shadow-md');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-100');
            }
        });
    }

    function handleLeaderboardFilterClick(key) {
        currentLeaderboardFilter = key;
        updateLeaderboardFilterUI();
        setupLeaderboardListener();
    }
    
    // --- TIMER Logic ---
    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const paddedMinutes = String(minutes).padStart(2, '0');
        const paddedSeconds = String(seconds).padStart(2, '0');
        return `${paddedMinutes}:${paddedSeconds}`;
    }
    
    function updatePauseButton() {
        if (isTimerRunning) {
            pauseButton.textContent = getLangText('button_pause');
            pauseButton.classList.add('bg-gray-500');
            pauseButton.classList.remove('bg-green-500');
        } else {
            if (timeElapsed === 0) {
                pauseButton.textContent = getLangText('button_start');
            } else {
                pauseButton.textContent = getLangText('button_play');
            }
            pauseButton.classList.remove('bg-gray-500');
            pauseButton.classList.add('bg-green-500');
        }
    }

    function startTimer() {
        if (isTimerRunning) return;

        timerInterval = setInterval(() => {
            timeElapsed++;
            timerDisplay.textContent = formatTime(timeElapsed);
        }, 1000);
        isTimerRunning = true;
        updatePauseButton();
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        isTimerRunning = false;
        updatePauseButton();
    }

    function toggleTimer() {
        // Prevent starting if name is empty
        if (playerNameInput.value.trim().length === 0 && !isTimerRunning) {
            messageBox.textContent = getLangText('message_enter_name');
            return;
        }
        
        const gameSolved = currentBoard.flat().every(v => v !== 0) && currentBoard.flat().every((v, i) => v === fullSolution.flat()[i]);
        if (gameSolved) return;


        if (isTimerRunning) {
            stopTimer();
            messageBox.textContent = getLangText('message_paused');
            toggleControls(true); 
            playerNameInput.disabled = false;
        } else {
            startTimer();
            createAudioContext(); 
            const {row, col} = selectedCell;
            
            if (row !== -1) {
                messageBox.textContent = getLangText('message_select_cell', row + 1, col + 1);
            } else {
                messageBox.textContent = getLangText('message_press_play_to_start');
            }

            toggleControls(false); 
            playerNameInput.disabled = true;
        }
    }


    // --- LANGUAGE Logic ---
    function getLangText(key, ...args) {
        const text = LANGUAGES[currentLang][key];
        if (typeof text === 'function') {
            return text(...args);
        }
        return text;
    }

    function updateLanguage() {
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (key.startsWith('button_hint')) {
                el.textContent = getLangText('button_hint', hintsRemaining);
            } else {
                if (el.id !== 'pause-button') {
                     el.textContent = getLangText(key);
                }
            }
        });

        // UPDATED: Set the placeholder text based ONLY on the selected language
        playerNameInput.placeholder = getLangText('input_placeholder');
        
        updatePauseButton();

        if (!isTimerRunning) {
            if (playerNameInput.value.trim().length === 0) {
                 messageBox.textContent = getLangText('message_enter_name');
            } else if (timeElapsed > 0) { 
                messageBox.textContent = getLangText('message_paused');
            } else { 
                const levelText = getLangText(`difficulty_${currentDifficultyKey.toLowerCase()}`);
                messageBox.textContent = getLangText('message_loaded', levelText);
            }
        }

        langToggleButton.textContent = getLangText('lang_toggle_text');

        renderBoard();
        updateDifficultyUI();
        updateThemeUI();
        updateLeaderboardFilterUI();
        setupLeaderboardListener();
        handleLeaderboardFilterClick(currentLeaderboardFilter);
    }


    // --- UI/Game Logic ---

    function showModal(titleKey, contentKey, isSuccess=false, time=null){
        const title = getLangText(titleKey);
        let content;
        if (time) {
            content = getLangText(contentKey, time);
        } else {
            content = getLangText(contentKey);
        }

        modalTitle.textContent = title;
        modalContent.textContent = content;
        
        // Use primary color dynamically
        const primaryColor = THEMES[currentThemeKey].color;
        
        modalTitle.style.color = isSuccess ? primaryColor : '#dc2626'; // Red-600
        modalCloseButton.style.backgroundColor = isSuccess ? primaryColor : '#ef4444'; // Red-500
        modalCloseButton.style.borderColor = isSuccess ? primaryColor : '#b91c1c'; // Red-700
        
        modal.style.display = 'flex';
    }
    function hideModal(){ modal.style.display = 'none'; }

    function checkNameAndEnableStart() {
        const isNameValid = playerNameInput.value.trim().length > 0;
        
        // Only enable pauseButton (Start/Resume) if a valid name is entered and game is not solved
        if (isNameValid) {
            const gameSolved = currentBoard.flat().every(v => v !== 0) && currentBoard.flat().every((v, i) => v === fullSolution.flat()[i]);
            pauseButton.disabled = gameSolved;
            
            if (!isTimerRunning) {
                 const levelText = getLangText(`difficulty_${currentDifficultyKey.toLowerCase()}`);
                 if (timeElapsed === 0) {
                     messageBox.textContent = getLangText('message_loaded', levelText);
                     messageBox.textContent += " " + getLangText('message_press_play_to_start');
                 } else {
                     messageBox.textContent = getLangText('message_paused');
                 }
            }
        } else {
            // Disable start button and show name prompt
            pauseButton.disabled = true;
            if (!isTimerRunning) {
                messageBox.textContent = getLangText('message_enter_name');
            }
        }
    }
    
    function toggleControls(disableAllGameInput) {
        const gameNotSolved = currentBoard.flat().includes(0) || currentBoard.flat().some((v, i) => v !== fullSolution.flat()[i]);
        
        // pauseButton control is now split: name validation via checkNameAndEnableStart, and solve status here.
        checkNameAndEnableStart(); 
        
        const isDisabled = disableAllGameInput || !gameNotSolved; 
        
        checkButton.disabled = isDisabled;
        hintButton.disabled = isDisabled || hintsRemaining === 0;

        let isSelectedFixed = true; // Assume fixed unless proven otherwise
        if (selectedCell.row !== -1 && selectedCell.col !== -1) {
            isSelectedFixed = initialBoard[selectedCell.row][selectedCell.col] !== 0;
        }
        
        // Number buttons/clear button are disabled if general game input is disabled, OR if a fixed cell is selected
        numberButtons.forEach(btn => btn.disabled = isDisabled || isSelectedFixed);
        clearButton.disabled = isDisabled || isSelectedFixed;
    }
    
    function updateDifficultyUI() {
        // Use the primary color for the active difficulty button
        difficultyButtons.forEach(btn => {
            if (btn.dataset.level === currentDifficultyKey) {
                btn.style.backgroundColor = THEMES[currentThemeKey].color;
                btn.classList.add('text-white', 'shadow-md');
                btn.classList.remove('bg-gray-200', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-100');
            } else {
                btn.style.backgroundColor = '';
                btn.classList.remove('text-white', 'shadow-md');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'border-gray-300', 'hover:bg-gray-100');
            }
        });
    }

    async function setupNewGame(){
        if (!isAuthReady) {
            messageBox.textContent = getLangText('message_generating');
            return;
        }

        messageBox.textContent = getLangText('message_generating');
        
        stopTimer(); 
        timerDisplay.textContent = '00:00';
        timeElapsed = 0; // Reset time elapsed

        hintsRemaining = HINT_LIMIT;
        hintButton.textContent = getLangText('button_hint', hintsRemaining);

        const prev = document.querySelector('.cell.selected');
        if(prev) prev.classList.remove('selected');
        selectedCell = {row:-1, col:-1};
        
        toggleControls(true); 
        playerNameInput.disabled = false; 

        await new Promise(r => setTimeout(r, 10)); 

        try {
            const { puzzle, solution } = generateNewPuzzle(currentDifficulty);

            initialBoard = puzzle.map(r => [...r]);
            fullSolution = solution;
            currentBoard = puzzle.map(r => [...r]);
            
            renderBoard();
            
            // Re-check name status after puzzle loads
            checkNameAndEnableStart();
            updatePauseButton(); 
            
        } catch(e) {
            console.error("Error generating puzzle:", e);
            messageBox.textContent = "Error generating puzzle."; 
        }
    }

    function renderBoard(){
        if (currentBoard.length !== 9) return;

        gridElement.innerHTML = '';
        const rowText = getLangText('aria_row');
        const colText = getLangText('aria_col');
        
        const selectedValue = selectedCell.row !== -1 ? currentBoard[selectedCell.row][selectedCell.col] : 0;
        const selectedBoxRow = selectedCell.row !== -1 ? Math.floor(selectedCell.row / 3) : -1;
        const selectedBoxCol = selectedCell.col !== -1 ? Math.floor(selectedCell.col / 3) : -1;
        
        const isGameStopped = !isTimerRunning; 
        
        for(let r=0;r<9;r++){
            for(let c=0;c<9;c++){
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.setAttribute('data-row', r);
                cell.setAttribute('data-col', c);
                cell.setAttribute('role','gridcell');
                
                const isFixed = initialBoard[r][c] !== 0;
                const cellTabIndex = !isFixed ? 0 : -1;
                cell.setAttribute('tabindex', cellTabIndex);

                cell.setAttribute('aria-label', `${rowText} ${r+1} ${colText} ${c+1}`); 
                
                // Add Drag-and-Drop functionality to the cells
                if (!isFixed) {
                    // Allow dropping a number if the cell is not fixed
                    cell.addEventListener('dragover', (ev) => {
                         if (isTimerRunning && playerNameInput.value.trim().length > 0) {
                            ev.preventDefault(); // Allows the drop event
                            ev.dataTransfer.dropEffect = "copy";
                        }
                    });

                    cell.addEventListener('drop', (ev) => {
                        ev.preventDefault();
                        const draggedData = ev.dataTransfer.getData("text/plain");
                        const num = parseInt(draggedData);

                        if (isNaN(num) || num < 1 || num > 9) return;

                        // Treat as a click on the cell first to update selection
                        handleCellClick(r, c); 
                        
                        // Then process the number input (which checks fixed status, timer, name)
                        handleNumberInput(num);
                    });
                }


                const value = currentBoard[r][c];
                cell.textContent = value === 0 ? '' : value;

                if(isFixed){
                    cell.classList.add('initial-value'); 
                }

                if (selectedCell.row !== -1) {
                    const inSameRegion = (
                        r === selectedCell.row || 
                        c === selectedCell.col || 
                        (Math.floor(r / 3) === selectedBoxRow && Math.floor(c / 3) === selectedBoxCol)
                    );
                    if (inSameRegion) {
                        cell.classList.add('highlighted-related');
                    }

                    const isDuplicate = selectedValue !== 0 && value === selectedValue;
                    if (isDuplicate) {
                        cell.classList.add('highlighted-duplicate');
                    }
                }

                if(r===selectedCell.row && c===selectedCell.col){
                    cell.classList.add('selected');
                }

                if (value !== 0 && value !== fullSolution[r][c] && !isFixed && !isGameStopped) {
                    cell.classList.add('error');
                } else {
                    cell.classList.remove('error');
                }

                cell.addEventListener('click', () => {
                    handleCellClick(r,c); 
                });
                
                cell.addEventListener('keydown', (ev)=>{
                    const isNameEmpty = playerNameInput.value.trim().length === 0;

                    if (!isTimerRunning) {
                        if (ev.key === 'ArrowRight' || ev.key === 'ArrowLeft' || ev.key === 'ArrowUp' || ev.key === 'ArrowDown') {
                            let newR = r, newC = c;
                            if (ev.key === 'ArrowRight') newC = c + 1;
                            if (ev.key === 'ArrowLeft') newC = c - 1;
                            if (ev.key === 'ArrowUp') newR = r - 1;
                            if (ev.key === 'ArrowDown') newR = r + 1;
                            if (newR >= 0 && newR < 9 && newC >= 0 && newC < 9) moveSelection(newR, newC);
                            ev.preventDefault();
                        } else if (((ev.key >= '1' && ev.key <= '9') || ev.key === 'Backspace' || ev.key === 'Delete' || ev.key === '0')) {
                            // Block keyboard input if not running or name is empty, but allow movement
                             if (isNameEmpty) {
                                messageBox.textContent = getLangText('message_enter_name');
                             } else {
                                messageBox.textContent = getLangText('message_press_play_to_start');
                             }
                             ev.preventDefault();
                        }
                        return; 
                    } 

                    const key = ev.key;
                    if (key >= '1' && key <= '9') {
                        handleNumberInput(parseInt(key));
                        ev.preventDefault();
                    } else if (key === 'Backspace' || key === 'Delete' || key === '0') {
                        handleNumberInput(0);
                        ev.preventDefault();
                    } else if (key === 'ArrowRight' || key === 'ArrowLeft' || key === 'ArrowUp' || key === 'ArrowDown') {
                        let newR = r, newC = c;
                        if (key === 'ArrowRight') newC = c + 1;
                        if (key === 'ArrowLeft') newC = c - 1;
                        if (key === 'ArrowUp') newR = r - 1;
                        if (key === 'ArrowDown') newR = r + 1;
                        if (newR >= 0 && newR < 9 && newC >= 0 && newC < 9) moveSelection(newR, newC);
                        ev.preventDefault();
                    }
                });

                gridElement.appendChild(cell);
            }
        }
    }

    function handleCellClick(r,c){
        if(r<0||r>8||c<0||c>8) return;

        selectedCell = {row:r, col:c};
        renderBoard();

        const newSel = document.querySelector(`[data-row='${r}'][data-col='${c}']`);
        if(newSel) {
            newSel.focus();
            messageBox.textContent = getLangText('message_select_cell', r + 1, c + 1);
        }

        toggleControls(!isTimerRunning);
    }

    function moveSelection(r,c){
        if(r<0) r=0; if(r>8) r=8; if(c<0) c=0; if(c>8) c=8;
        handleCellClick(r,c);
    }

    function handleNumberInput(number){
        const {row, col} = selectedCell;
        
        if (!isTimerRunning) {
             messageBox.textContent = getLangText('message_press_play_to_start'); 
             return; 
        }
        
        if(playerNameInput.value.trim().length === 0){
             messageBox.textContent = getLangText('message_enter_name');
             return;
        }

        if(row === -1 || col === -1){ messageBox.textContent = getLangText('message_no_selection'); return; }
        if(initialBoard[row][col] !== 0){ messageBox.textContent = getLangText('message_fixed_value'); return; }
        
        currentBoard[row][col] = number;
        renderBoard();

        if(currentBoard.flat().every(v => v !== 0)){
            selectedCell = {row:-1, col:-1};
            checkSolution();
        }
    }

    async function checkSolution(){
        let errors = false;
        let filled = true;
        
        for(let r=0;r<9;r++){
            for(let c=0;c<9;c++){
                const val = currentBoard[r][c];
                
                if(val === 0) { filled = false; continue; }
                if(val !== fullSolution[r][c]){
                    errors = true;
                }
            }
        }
        
        renderBoard(); 

        if(!filled){
            messageBox.textContent = getLangText('message_keep_going');
            return;
        }

        stopTimer(); 

        if(errors){
            playSound('error');
            showModal('modal_error_title', 'modal_error_content', false);
            toggleControls(true); 
        } else {
            const finalTime = formatTime(timeElapsed);
            
            showModal('modal_solved_title', 'message_score_saving', true, finalTime);
            
            await saveScoreToFirestore(timeElapsed, currentDifficultyKey);
            
            playSound('success');
            showModal('modal_solved_title', 'modal_solved_content', true, finalTime);

            toggleControls(true); 
        }
    }
    
    function giveHint() {
        if (!isTimerRunning) return;
        if (hintsRemaining <= 0) { messageBox.textContent = getLangText('message_no_hints'); return; }
        
        const { row, col } = selectedCell;
        if (row === -1 || col === -1 || currentBoard[row][col] !== 0) { 
            messageBox.textContent = getLangText('message_select_hint_cell'); 
            return; 
        }

        const correctValue = fullSolution[row][col];
        currentBoard[row][col] = correctValue;
        initialBoard[row][col] = correctValue; 
        
        hintsRemaining--;
        hintButton.textContent = getLangText('button_hint', hintsRemaining);
        
        renderBoard();
        messageBox.textContent = getLangText('message_hint_used', correctValue, hintsRemaining);
        
        if(currentBoard.flat().every(v => v !== 0)){
            checkSolution();
        }
        toggleControls(false); 
    }


    // --- Core Sudoku Generation Logic (unchanged) ---

    function isSafe(grid, row, col, num) {
        for (let x = 0; x < 9; x++) {
            if (grid[row][x] === num || grid[x][col] === num) return false;
        }
        const startRow = row - row % 3;
        const startCol = col - col % 3;
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                if (grid[i + startRow][j + startCol] === num) return false;
            }
        }
        return true;
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function fillGrid(grid) {
        let row = -1;
        let col = -1;
        let isEmpty = true;

        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                if (grid[r][c] === 0) { row = r; col = c; isEmpty = false; break; }
            }
            if (!isEmpty) break;
        }
        if (isEmpty) return true;

        const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        shuffle(nums);

        for (const num of nums) {
            if (isSafe(grid, row, col, num)) {
                grid[row][col] = num;
                if (fillGrid(grid)) return true;
                grid[row][col] = 0;
            }
        }
        return false;
    }

    function countSolutions(grid, limit = 2) {
        let solutions = 0;
        function solve(tempGrid) {
            if (solutions >= limit) return;
            let row = -1, col = -1;
            let isEmpty = true;
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (tempGrid[r][c] === 0) { row = r; col = c; isEmpty = false; break; }
                }
                if (!isEmpty) break;
            }
            if (isEmpty) { solutions++; return; }
            for (let num = 1; num <= 9; num++) {
                if (isSafe(tempGrid, row, col, num)) {
                    tempGrid[row][col] = num;
                    solve(tempGrid);
                    tempGrid[row][col] = 0;
                }
            }
        }
        const tempGrid = grid.map(r => [...r]);
        solve(tempGrid);
        return solutions;
    }

    function makePuzzle(fullGrid, cluesToKeep) {
        const puzzle = fullGrid.map(r => [...r]);
        let cells = [];
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                cells.push({ r, c });
            }
        }
        shuffle(cells);

        let removedCount = 81 - cluesToKeep;
        let currentRemoved = 0;

        for (const { r, c } of cells) {
            if (currentRemoved >= removedCount) break;

            const backup = puzzle[r][c];
            puzzle[r][c] = 0;

            if (countSolutions(puzzle, 2) === 1) {
                currentRemoved++;
            } else {
                puzzle[r][c] = backup;
            }
        }
        return puzzle;
    }

    function generateNewPuzzle(cluesToKeep) {
        const newSolution = Array.from({ length: 9 }, () => Array(9).fill(0));
        fillGrid(newSolution);
        const newPuzzle = makePuzzle(newSolution, cluesToKeep);
        return { puzzle: newPuzzle, solution: newSolution };
    }


    // --- Event wiring ---
    
    // Add drag-and-drop support and existing click handler to number buttons
    numberButtons.forEach(button=>{
        
        // 1. Drag Start Listener
        button.addEventListener('dragstart', (ev) => {
            const num = button.getAttribute('data-number');
            // Prevent drag if button is disabled (e.g., game paused or not started)
            if (button.disabled || !isTimerRunning) {
                ev.preventDefault();
                return;
            }
            ev.dataTransfer.setData("text/plain", num); 
            ev.dataTransfer.effectAllowed = "copy"; 
            button.classList.add('opacity-50'); 
        });
        
        // 2. Drag End Listener (cleanup)
        button.addEventListener('dragend', (ev) => {
            button.classList.remove('opacity-50'); 
        });
        
        // 3. Existing Click Listener
        button.addEventListener('click', (ev)=>{
            const num = parseInt(button.getAttribute('data-number'));
            handleNumberInput(num);
        });
    });
    
    difficultyButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.dataset.level;
            currentDifficultyKey = key;
            currentDifficulty = DIFFICULTY_LEVELS[key];
            updateDifficultyUI();
            setupNewGame();
        });
    });
    
    leaderboardFilterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            handleLeaderboardFilterClick(btn.dataset.leaderboard-filter);
        });
    });

    // Theme Color Selectors
    primaryColorSelectors.forEach(selector => {
        selector.addEventListener('click', () => {
            const key = selector.dataset.colorKey;
            applyTheme(key, currentBackgroundKey);
        });
    });
    
    // Theme Background Selectors
    backgroundSelectors.forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.dataset.bgKey;
            applyTheme(currentThemeKey, key);
        });
    });


    langToggleButton.addEventListener('click', () => {
        currentLang = currentLang === 'ms' ? 'en' : 'ms';
        updateLanguage();
    });

    pauseButton.addEventListener('click', toggleTimer); 
    checkButton.addEventListener('click', checkSolution);
    newGameButton.addEventListener('click', setupNewGame);
    modalCloseButton.addEventListener('click', hideModal);
    hintButton.addEventListener('click', giveHint);
    
    // Name input listener to enable/disable start button
    playerNameInput.addEventListener('input', (ev) => {
        userName = ev.target.value.trim();
        checkNameAndEnableStart();
    });

    document.addEventListener('keydown', (ev)=>{
        const key = ev.key;
        if(selectedCell.row !== -1 && isTimerRunning){
            if (key >= '1' && key <= '9') {
                handleNumberInput(parseInt(key));
            } else if (key === 'Backspace' || key === 'Delete' || key === '0') {
                handleNumberInput(0);
            }
        } else if (selectedCell.row !== -1 && !isTimerRunning && (key >= '1' && key <= '9')) {
             if (playerNameInput.value.trim().length === 0) {
                 messageBox.textContent = getLangText('message_enter_name');
             } else {
                 messageBox.textContent = getLangText('message_press_play_to_start');
             }
        }
    });

    // initialize
    window.addEventListener('load', () => {
        // Clear input field on load to force name entry
        playerNameInput.value = ''; 
        
        applyTheme(currentThemeKey, currentBackgroundKey); 
        updateLanguage(); 
        initializeFirebase(); 
    });
</script>
</body>
</html>
